<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operatora - LogisticOps</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map { height: 500px; border-radius: 8px; border: 2px solid #dee2e6; }

        .route-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .route-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border-color: #0d6efd;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .route-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .justification-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #0d6efd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .validation-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin: 3px;
        }

        .badge-clear { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-permit { background: #cfe2ff; color: #084298; }

        .infrastructure-details {
            background: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }

        .permits-section {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .permit-item {
            background: white;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .permit-location {
            font-weight: bold;
            color: #d63384;
            font-size: 1.05em;
        }

        .permit-city {
            color: #0d6efd;
            font-weight: 600;
        }

        .permit-road {
            color: #6c757d;
            font-size: 0.9em;
        }

        .permit-description {
            color: #495057;
            margin-top: 5px;
            font-size: 0.95em;
        }

        .btn-action {
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .driver-list-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }

        .driver-online { color: #28a745; font-weight: bold; }
        .driver-offline { color: #6c757d; }

        .transport-mode-selector {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .transport-mode-option {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .transport-mode-option:hover {
            border-color: #0d6efd;
            background: #f0f8ff;
        }

        .transport-mode-option.selected {
            border-color: #0d6efd;
            background: #e7f3ff;
        }

        .transport-mode-icon {
            font-size: 2em;
            margin-right: 10px;
        }

        .route-map-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .route-map-container {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .route-map-header {
            padding: 20px;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-map-body {
            flex: 1;
            position: relative;
        }

        #route-preview-map {
            width: 100%;
            height: 100%;
        }

        /* Driver Location Modal */
        .driver-location-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .driver-location-container {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .driver-location-header {
            padding: 20px;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .driver-location-stats {
            display: flex;
            gap: 30px;
            font-size: 0.9em;
        }

        .driver-stat {
            display: flex;
            flex-direction: column;
        }

        .driver-stat-label {
            color: #6c757d;
            font-size: 0.85em;
        }

        .driver-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #0d6efd;
        }

        .driver-location-body {
            flex: 1;
            position: relative;
        }

        #driver-location-map {
            width: 100%;
            height: 100%;
        }

        /* ‚úÖ Dodatkowy styl dla przycisku mapy */
        .btn-map-driver {
            margin-left: 10px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand">LogisticOps - Dashboard Operatora</span>
        <div>
            <span class="text-light me-3">Witaj, <span id="username">Operator</span></span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">Wyloguj</button>
        </div>
    </div>
</nav>

<div class="container-fluid p-3">
    <div class="mb-3">
        <button id="routes-tab" class="btn btn-primary me-2" onclick="switchTab('routes')">
            ZarzƒÖdzanie Trasami
        </button>
        <button id="drivers-tab" class="btn btn-outline-primary me-2" onclick="switchTab('drivers')">
            Kierowcy
        </button>
        <button id="vehicles-tab" class="btn btn-outline-primary me-2" onclick="switchTab('vehicles')">
            Zestawy Transportowe
        </button>
        <button id="add-equipment-tab" class="btn btn-outline-primary" onclick="switchTab('add-equipment')">
            Dodaj Sprzƒôt
        </button>
    </div>

    <!-- Routes Section -->
    <div id="routes-section">
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Nowa Trasa</h5>
                    </div>
                    <div class="card-body">
                        <form id="route-form">
                            <div class="mb-3">
                                <label class="form-label">Zestaw Transportowy</label>
                                <select id="transport-set" class="form-select" required>
                                    <option value="">≈Åadowanie...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Adres startowy</label>
                                <input type="text" id="start-address" class="form-control"
                                       placeholder="np. ul. Marsza≈Çkowska 10, Warszawa" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Adres docelowy</label>
                                <input type="text" id="end-address" class="form-control"
                                       placeholder="np. ul. ≈öwiƒôty Marcin 24, Pozna≈Ñ" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Kierowca (opcjonalnie)</label>
                                <select id="driver-username" class="form-select">
                                    <option value="">Wybierz kierowcƒô...</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Utw√≥rz Trasƒô</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <h3 class="mb-3">PodglƒÖd trasy</h3>
                <div id="map"></div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Wszystkie Trasy</h3>
                    <button id="refresh-routes" class="btn btn-outline-primary" onclick="refreshRoutes()">
                        Od≈õwie≈º
                    </button>
                </div>
                <div id="routes-list">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">≈Åadowanie tras...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drivers Section -->
    <div id="drivers-section" style="display: none;">
        <div class="row">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Lista Kierowc√≥w</h3>
                    <div>
                        <button class="btn btn-primary me-2" onclick="showAddDriverModal()">
                            Dodaj Kierowcƒô
                        </button>
                        <button id="refresh-drivers-list" class="btn btn-outline-primary" onclick="refreshDrivers()">
                            Od≈õwie≈º
                        </button>
                    </div>
                </div>
                <div id="drivers-list">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicles Section -->
    <div id="vehicles-section" style="display: none;">
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Utw√≥rz Zestaw</h5>
                    </div>
                    <div class="card-body">
                        <form id="vehicle-form">
                            <div class="mb-3">
                                <label class="form-label">Ciƒô≈ºar√≥wka</label>
                                <select id="transporter-select" class="form-select" required>
                                    <option value="">≈Åadowanie...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">≈Åadunek</label>
                                <select id="cargo-select" class="form-select" required onchange="checkCargoCapabilities()">
                                    <option value="">≈Åadowanie...</option>
                                </select>
                            </div>

                            <div class="transport-mode-selector" id="transport-mode-container" style="display:none;">
                                <label class="form-label"><strong>Typ transportu:</strong></label>

                                <div class="transport-mode-option" data-mode="trailer" onclick="selectTransportMode('trailer')">
                                    <span class="transport-mode-icon">üöõ</span>
                                    <div style="display: inline-block; vertical-align: top;">
                                        <strong>Na lawecie (naczepa)</strong><br>
                                        <small>Oszczƒôdno≈õƒá zu≈ºycia pojazdu, bezpieczny transport na d≈Çugie dystanse</small>
                                    </div>
                                </div>

                                <div class="transport-mode-option" data-mode="self" onclick="selectTransportMode('self')">
                                    <span class="transport-mode-icon">üöó</span>
                                    <div style="display: inline-block; vertical-align: top;">
                                        <strong>Na w≈Çasnych ko≈Çach</strong><br>
                                        <small>Pojazd jedzie samodzielnie, szybszy dojazd na kr√≥tkie dystanse</small>
                                    </div>
                                </div>

                                <input type="hidden" id="transport-mode" value="trailer">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Opis</label>
                                <input type="text" id="set-description" class="form-control"
                                       placeholder="np. Transport maszyn budowlanych">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Utw√≥rz</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">IstniejƒÖce Zestawy</h5>
                    </div>
                    <div class="card-body">
                        <div id="existing-sets">
                            <div class="text-center p-4">
                                <div class="spinner-border text-primary"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Equipment Section -->
    <div id="add-equipment-section" style="display: none;">
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Dodaj Ciƒô≈ºar√≥wkƒô</h5>
                    </div>
                    <div class="card-body">
                        <form id="add-transporter-form">
                            <div class="mb-3">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" id="trans-model" required placeholder="np. MAN TGX 26.480">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Waga (kg)</label>
                                <input type="number" class="form-control" id="trans-weight" required placeholder="np. 26000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Wysoko≈õƒá (cm)</label>
                                <input type="number" class="form-control" id="trans-height" required placeholder="np. 350">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Maks. nacisk na o≈õ (kg)</label>
                                <input type="number" class="form-control" id="trans-axle" required placeholder="np. 11500">
                            </div>
                            <button type="submit" class="btn btn-success w-100">Dodaj Ciƒô≈ºar√≥wkƒô</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Dodaj ≈Åadunek</h5>
                    </div>
                    <div class="card-body">
                        <form id="add-cargo-form">
                            <div class="mb-3">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" id="cargo-model" required placeholder="np. Leopard 2A5">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Waga (kg)</label>
                                <input type="number" class="form-control" id="cargo-weight" required placeholder="np. 62000">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Wysoko≈õƒá (cm)</label>
                                <input type="number" class="form-control" id="cargo-height" required placeholder="np. 300">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Maks. nacisk na o≈õ (kg)</label>
                                <input type="number" class="form-control" id="cargo-axle" required placeholder="np. 15500">
                            </div>
                            <button type="submit" class="btn btn-warning w-100">Dodaj ≈Åadunek</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <h4>Ciƒô≈ºar√≥wki</h4>
                <div id="transporters-list"></div>
            </div>
            <div class="col-md-6">
                <h4>≈Åadunki</h4>
                <div id="cargo-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ MODAL DO WY≈öWIETLANIA MAPY TRASY -->
<div id="route-map-modal" class="route-map-modal">
    <div class="route-map-container">
        <div class="route-map-header">
            <h4 id="route-map-title">Trasa na mapie</h4>
            <button class="btn btn-secondary" onclick="closeRouteMapModal()">Zamknij</button>
        </div>
        <div class="route-map-body">
            <div id="route-preview-map"></div>
        </div>
    </div>
</div>

<!-- ‚úÖ MODAL ≈öLEDZENIA KIEROWCY NA ≈ªYWO -->
<div id="driver-location-modal" class="driver-location-modal">
    <div class="driver-location-container">
        <div class="driver-location-header">
            <div>
                <h4 id="driver-location-title">üìç Lokalizacja kierowcy</h4>
                <div class="driver-location-stats" id="driver-stats">
                    <div class="driver-stat">
                        <span class="driver-stat-label">Prƒôdko≈õƒá</span>
                        <span class="driver-stat-value" id="driver-speed">-- km/h</span>
                    </div>
                    <div class="driver-stat">
                        <span class="driver-stat-label">Ostatnia aktualizacja</span>
                        <span class="driver-stat-value" id="driver-last-update">--</span>
                    </div>
                    <div class="driver-stat">
                        <span class="driver-stat-label">Status</span>
                        <span class="driver-stat-value" id="driver-status-live">üü¢ Online</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="closeDriverLocationModal()">Zamknij</button>
        </div>
        <div class="driver-location-body">
            <div id="driver-location-map"></div>
        </div>
    </div>
</div>

<script src="/js/operator.js"></script>
<script>
    let operatorDashboard;
    let googleMapsLoaded = false;
    const token = localStorage.getItem('token');

    let allCargo = [];
    let selectedTransportMode = 'trailer';
    let routePreviewMap = null;

    // ‚úÖ Zmienne do ≈õledzenia kierowcy
    let driverLocationMap = null;
    let driverLocationMarker = null;
    let driverLocationInterval = null;
    let currentTrackedDriver = null;

    if (!token) window.location.href = '/login.html';

    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        if (args[1]) {
            args[1].headers = { ...args[1].headers, 'Authorization': `Bearer ${token}` };
        } else {
            args[1] = { headers: { 'Authorization': `Bearer ${token}` } };
        }
        return originalFetch.apply(this, args);
    };

    function checkCargoCapabilities() {
        const cargoId = document.getElementById('cargo-select').value;
        const container = document.getElementById('transport-mode-container');

        if (!cargoId) {
            container.style.display = 'none';
            return;
        }

        const cargo = allCargo.find(c => c.id == cargoId);
        if (!cargo) {
            container.style.display = 'none';
            return;
        }

        if (cargo.canDriveAlone && cargo.totalWeightKg <= 5000) {
            container.style.display = 'block';
            selectTransportMode('trailer');
        } else {
            container.style.display = 'none';
            selectedTransportMode = 'trailer';
        }
    }

    function selectTransportMode(mode) {
        selectedTransportMode = mode;
        document.getElementById('transport-mode').value = mode;

        document.querySelectorAll('.transport-mode-option').forEach(el => {
            el.classList.remove('selected');
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
    }

    async function initializeSystem() {
        try {
            const username = localStorage.getItem('username');
            if (username) document.getElementById('username').textContent = username;

            await loadGoogleMaps();

            if (window.OperatorDashboard) {
                operatorDashboard = new window.OperatorDashboard();
                window.operatorDashboard = operatorDashboard;
                operatorDashboard.initMap();
                operatorDashboard.loadDriversList();
            }

            switchTab('routes');

        } catch (error) {
            console.error('Initialization failed:', error);
        }
    }

    async function loadGoogleMaps() {
        if (googleMapsLoaded) return Promise.resolve();

        try {
            const response = await fetch('/api/config/google-maps-key');
            if (!response.ok) throw new Error('Cannot get API key');

            const apiKey = await response.text();
            if (!apiKey || apiKey === 'Google Maps API not configured') {
                throw new Error('API key not configured');
            }

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=onGoogleMapsLoaded`;
                script.async = true;
                script.defer = true;
                script.onerror = () => reject(new Error('Failed to load'));

                window.onGoogleMapsLoaded = () => {
                    googleMapsLoaded = true;
                    resolve();
                };

                document.head.appendChild(script);
            });
        } catch (error) {
            throw new Error('Google Maps loading failed: ' + error.message);
        }
    }

    // ‚úÖ ULEPSZONA FUNKCJA - Dodawanie przycisk√≥w do kierowc√≥w
    window.addEventListener('load', () => {
        setTimeout(() => {
            if (operatorDashboard) {
                console.log('‚úÖ Overriding displayRoutes and displayDrivers');
                operatorDashboard.displayRoutes = displayRoutesWithAllButtons;

                // Przechwyƒá oryginalnƒÖ funkcjƒô displayDrivers
                const originalDisplayDrivers = operatorDashboard.displayDrivers.bind(operatorDashboard);
                operatorDashboard.displayDrivers = function() {
                    // Wywo≈Çaj oryginalnƒÖ funkcjƒô
                    originalDisplayDrivers();

                    // Po 100ms dodaj przyciski (daj czas na wyrenderowanie HTML)
                    setTimeout(() => {
                        addMapButtonsToDrivers();
                    }, 100);
                };
            }
        }, 500);
    });

    // ‚úÖ POPRAWIONA FUNKCJA - Dodaje przyciski mapy do wszystkich kierowc√≥w online
    function addMapButtonsToDrivers() {
        console.log('üîç Szukam kierowc√≥w online...');
        const driversList = document.getElementById('drivers-list');

        if (!driversList) {
            console.warn('‚ö†Ô∏è Nie znaleziono elementu drivers-list');
            return;
        }

        // Znajd≈∫ wszystkie elementy kierowc√≥w
        const driverItems = driversList.querySelectorAll('.driver-list-item');
        console.log(`üìã Znaleziono ${driverItems.length} kierowc√≥w`);

        driverItems.forEach((item, index) => {
            console.log(`   Kierowca ${index + 1}:`, item.textContent.substring(0, 50));

            // Sprawd≈∫ czy kierowca jest online (szukamy elementu z klasƒÖ driver-online lub tekstu "Online")
            const isOnline = item.querySelector('.driver-online') ||
                item.textContent.includes('Online') ||
                item.innerHTML.includes('üü¢');

            if (!isOnline) {
                console.log(`   ‚ö™ Kierowca offline, pomijam`);
                return;
            }

            // Sprawd≈∫ czy przycisk ju≈º istnieje
            if (item.querySelector('.btn-map-driver')) {
                console.log(`   ‚úÖ Przycisk ju≈º istnieje`);
                return;
            }

            // Pobierz username kierowcy
            let driverUsername = null;

            // Pr√≥ba 1: Szukaj w <strong>
            const strongElement = item.querySelector('strong');
            if (strongElement) {
                driverUsername = strongElement.textContent.trim();
            }

            // Pr√≥ba 2: Szukaj w ca≈Çym tek≈õcie
            if (!driverUsername) {
                const textMatch = item.textContent.match(/([A-Z][a-z]+\s[A-Z][a-z]+)/);
                if (textMatch) {
                    driverUsername = textMatch[1];
                }
            }

            // Pr√≥ba 3: Szukaj w atrybucie data
            if (!driverUsername && item.dataset.driver) {
                driverUsername = item.dataset.driver;
            }

            if (!driverUsername) {
                console.warn(`   ‚ö†Ô∏è Nie mo≈ºna znale≈∫ƒá username kierowcy`);
                return;
            }

            console.log(`   üü¢ Dodajƒô przycisk dla: ${driverUsername}`);

            // Utw√≥rz przycisk
            const mapButton = document.createElement('button');
            mapButton.className = 'btn btn-success btn-sm btn-map-driver';
            mapButton.innerHTML = 'üó∫Ô∏è Zobacz na mapie';
            mapButton.onclick = (e) => {
                e.stopPropagation();
                showDriverLocation(driverUsername);
            };

            // Dodaj przycisk do elementu kierowcy
            item.appendChild(mapButton);
            console.log(`   ‚úÖ Dodano przycisk!`);
        });
    }

    async function displayRoutesWithAllButtons() {
        const container = document.getElementById('routes-list');

        if (!operatorDashboard.routes || operatorDashboard.routes.length === 0) {
            container.innerHTML = `
                <div class="text-center p-5">
                    <h4 class="text-muted">Brak tras</h4>
                    <p>Utw√≥rz pierwszƒÖ trasƒô u≈ºywajƒÖc formularza po lewej stronie</p>
                </div>
            `;
            return;
        }

        let html = '';
        for (const route of operatorDashboard.routes) {
            const validation = await getRouteValidation(route.id);
            html += createCompleteRouteCard(route, validation);
        }
        container.innerHTML = html;
    }

    async function getRouteValidation(routeId) {
        try {
            const response = await fetch(`/api/routes/${routeId}/validation-details`);
            if (!response.ok) return null;
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error loading validation:', error);
            return null;
        }
    }

    function createCompleteRouteCard(route, validation) {
        let html = `
            <div class="route-card">
                <div class="route-header">
                    <div>
                        <h4 style="color:#0d6efd;margin-bottom:10px;">Trasa #${route.id}</h4>
                        <p class="mb-1"><strong>Start:</strong> ${route.startAddress}</p>
                        <p class="mb-1"><strong>Koniec:</strong> ${route.endAddress}</p>
                        <p class="mb-2"><strong>Status:</strong> <span class="badge bg-primary">${route.status}</span></p>
        `;

        if (validation && validation.validationAvailable) {
            html += '<div class="mt-2">';
            if (!validation.hasViolations && !validation.hasRestrictions) {
                html += '<span class="validation-badge badge-clear">‚úÖ Trasa sprawdzona i bezpieczna</span>';
            }
            if (validation.hasRestrictions) {
                html += '<span class="validation-badge badge-warning">‚ö†Ô∏è Ograniczenia sprawdzone</span>';
            }
            if (validation.hasViolations) {
                html += '<span class="validation-badge badge-danger">üîÑ U≈ºyto trasy alternatywnej</span>';
            }
            if (validation.permits && validation.permits.length > 0) {
                html += `<span class="validation-badge badge-permit">üìã Wymaga ${validation.permits.length} pozwole≈Ñ</span>`;
            }
            html += '</div>';
        }

        html += `
                    </div>
                    <div class="route-actions">
                        <button class="btn btn-info btn-action" onclick="showFullValidation(${route.id})" title="Szczeg√≥≈Çowa walidacja most√≥w i tuneli">
                            Szczeg√≥≈Çy Walidacji
                        </button>
                        <button class="btn btn-success btn-action" onclick="showRouteOnMap(${route.id})" title="Wy≈õwietl trasƒô na mapie">
                            üó∫Ô∏è Poka≈º na mapie
                        </button>
        `;

        if (route.status === 'CREATED') {
            html += `
                        <button class="btn btn-primary btn-action" onclick="assignDriver(${route.id})" title="Przypisz kierowcƒô do trasy">
                            Przypisz Kierowcƒô
                        </button>
            `;
        }

        html += `
                        <button class="btn btn-danger btn-action" onclick="deleteRoute(${route.id})" title="Usu≈Ñ trasƒô">
                            Usu≈Ñ Trasƒô
                        </button>
                    </div>
                </div>
        `;

        if (validation && validation.transportSetInfo) {
            const info = validation.transportSetInfo;
            html += `
                <div class="infrastructure-details">
                    <h6><strong>Parametry zestawu transportowego:</strong></h6>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <small><strong>Opis:</strong> ${info.description || 'N/A'}</small>
                        </div>
                        <div class="col-md-2">
                            <small><strong>Masa:</strong> ${(info.totalWeight_kg/1000).toFixed(1)}t</small>
                        </div>
                        <div class="col-md-3">
                            <small><strong>Wysoko≈õƒá:</strong> ${(info.totalHeight_cm/100).toFixed(2)}m`;

            if (info.trailerHeight_cm && info.cargoHeight_cm) {
                html += ` (naczepa ${(info.trailerHeight_cm/100).toFixed(2)}m + ≈Çadunek ${(info.cargoHeight_cm/100).toFixed(2)}m)`;
            }

            html += `</small>
                        </div>
                        <div class="col-md-2">
                            <small><strong>D≈Çugo≈õƒá:</strong> ${(info.totalLength_cm/100).toFixed(2)}m</small>
                        </div>
                        <div class="col-md-2">
                            <small><strong>Szeroko≈õƒá:</strong> ${(info.totalWidth_cm/100).toFixed(2)}m</small>
                        </div>
                    </div>
                </div>
            `;
        }

        if (validation && validation.permits && validation.permits.length > 0) {
            html += `
                <div class="permits-section">
                    <h6><strong>‚ö†Ô∏è WYMAGANE POZWOLENIA NA PRZEJAZD (${validation.permits.length}):</strong></h6>
                    <p style="margin: 10px 0; font-size: 0.9em;">
                        Przed rozpoczƒôciem transportu nale≈ºy uzyskaƒá pozwolenia dla nastƒôpujƒÖcych obiekt√≥w:
                    </p>
            `;

            validation.permits.forEach((permit, index) => {
                const permitHtml = parsePermitString(permit, index + 1);
                html += permitHtml;
            });

            html += `
                    <div class="alert alert-warning mt-3 mb-0">
                        <small>
                            <strong>‚ÑπÔ∏è Informacja:</strong> Skontaktuj siƒô z zarzƒÖdami dr√≥g w odpowiednich miastach
                            w celu uzyskania pozwole≈Ñ na przejazd pojazdu nienormatywnego.
                        </small>
                    </div>
                </div>
            `;
        }

        if (validation && validation.routeJustification && validation.routeJustification.length > 0) {
            html += `
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleJustification(${route.id})">
                        üìã Dlaczego wybrano tƒô trasƒô? (Mosty/Tunele/Drogi)
                    </button>
                    <div id="justification-${route.id}" class="justification-box" style="display:none;">
            `;

            validation.routeJustification.forEach(line => {
                if (line.includes('‚ïê‚ïê‚ïê')) {
                    html += `<div style="font-weight:bold;color:#0d6efd;border-bottom:2px solid #0d6efd;padding:5px 0;margin-top:10px;">${escapeHtml(line)}</div>`;
                } else {
                    let className = '';
                    if (line.includes('MO≈ªNA PRZEJECHAƒÜ') || line.includes('ud≈∫wignie') || line.includes('‚úî')) {
                        className = 'style="color:#28a745;font-weight:bold;background:#d4edda;padding:6px;border-radius:4px;margin:4px 0;"';
                    } else if (line.includes('OMIJAMY') || line.includes('ZA CIƒò≈ªKI') || line.includes('ZA WYSOKI')) {
                        className = 'style="color:#dc3545;font-weight:bold;background:#f8d7da;padding:6px;border-radius:4px;margin:4px 0;"';
                    } else if (line.includes('‚ö†') || line.includes('UWAGA')) {
                        className = 'style="color:#856404;font-weight:bold;background:#fff3cd;padding:6px;border-radius:4px;margin:4px 0;"';
                    }
                    html += `<div ${className}>${escapeHtml(line)}</div>`;
                }
            });

            html += `
                    </div>
                </div>
            `;
        }

        html += `
            </div>
        `;

        return html;
    }

    function parsePermitString(permitString, index) {
        let html = `<div class="permit-item">`;
        html += `<div style="display:flex; align-items:center; margin-bottom:8px;">`;
        html += `<span style="background:#ff9800;color:white;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-weight:bold;margin-right:12px;">${index}</span>`;

        let location = '';
        let city = '';
        let road = '';
        let description = permitString;

        const cityMatch = permitString.match(/\(([^)]+)\)/);
        if (cityMatch) {
            city = cityMatch[1];
            const parts = permitString.split('(');
            location = parts[0].trim();
            description = permitString.substring(permitString.indexOf(')') + 1).trim();
        }

        const roadMatch = description.match(/- droga: ([^:]+):/);
        if (roadMatch) {
            road = roadMatch[1].trim();
            description = description.substring(description.lastIndexOf(':') + 1).trim();
        } else if (description.includes(':')) {
            const colonIndex = description.indexOf(':');
            if (!location) {
                location = description.substring(0, colonIndex).trim();
            }
            description = description.substring(colonIndex + 1).trim();
        }

        html += `<div style="flex:1;">`;

        if (location) {
            html += `<div class="permit-location">${escapeHtml(location)}</div>`;
        }

        if (city) {
            html += `<div class="permit-city">üìç ${escapeHtml(city)}</div>`;
        }

        if (road) {
            html += `<div class="permit-road">üõ£Ô∏è Droga: ${escapeHtml(road)}</div>`;
        }

        html += `<div class="permit-description">${escapeHtml(description)}</div>`;
        html += `</div></div></div>`;

        return html;
    }

    function toggleJustification(routeId) {
        const element = document.getElementById('justification-' + routeId);
        if (element) {
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function showFullValidation(routeId) {
        const validation = await getRouteValidation(routeId);
        if (!validation) {
            alert('Brak danych walidacji dla tej trasy');
            return;
        }

        let html = '<div style="max-height: 75vh; overflow-y: auto; padding: 20px;">';

        html += '<h3 style="color:#0d6efd;border-bottom:3px solid #0d6efd;padding-bottom:10px;">Pe≈Çna Walidacja Trasy #' + routeId + '</h3>';

        if (validation.transportSetInfo) {
            const info = validation.transportSetInfo;
            html += '<div style="background:#e7f3ff;padding:20px;border-radius:8px;margin:20px 0;border:2px solid #0d6efd;">';
            html += '<h5><strong>Parametry zestawu:</strong></h5>';
            html += '<ul style="margin:10px 0;line-height:1.8;">';
            html += `<li><strong>Opis:</strong> ${info.description || 'N/A'}</li>`;
            html += `<li><strong>Wysoko≈õƒá:</strong> ${(info.totalHeight_cm/100).toFixed(2)}m`;
            if (info.trailerHeight_cm && info.cargoHeight_cm) {
                html += ` (naczepa ${(info.trailerHeight_cm/100).toFixed(2)}m + ≈Çadunek ${(info.cargoHeight_cm/100).toFixed(2)}m)`;
            }
            html += `</li>`;
            html += `<li><strong>Waga:</strong> ${(info.totalWeight_kg/1000).toFixed(1)}t</li>`;
            html += `<li><strong>D≈Çugo≈õƒá:</strong> ${(info.totalLength_cm/100).toFixed(2)}m</li>`;
            html += `<li><strong>Szeroko≈õƒá:</strong> ${(info.totalWidth_cm/100).toFixed(2)}m</li>`;
            html += '</ul></div>';
        }

        if (validation.permits && validation.permits.length > 0) {
            html += '<div style="background:#fff3cd;padding:20px;border-radius:8px;margin-top:20px;border:2px solid #ffc107;">';
            html += `<h5 style="color:#856404;"><strong>‚ö†Ô∏è WYMAGANE POZWOLENIA (${validation.permits.length}):</strong></h5>`;
            html += '<ul style="margin:10px 0;line-height:2;">';
            validation.permits.forEach(permit => {
                html += `<li style="margin-bottom:10px;">${escapeHtml(permit)}</li>`;
            });
            html += '</ul>';
            html += '<div style="background:#fff;padding:10px;border-radius:4px;margin-top:15px;">';
            html += '<small><strong>üìû Kontakt:</strong> Skontaktuj siƒô z zarzƒÖdami dr√≥g w odpowiednich miastach przed rozpoczƒôciem transportu.</small>';
            html += '</div>';
            html += '</div>';
        }

        if (validation.routeJustification && validation.routeJustification.length > 0) {
            html += '<div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-top:20px;border:2px solid #28a745;">';
            html += '<h5 style="color:#28a745;"><strong>DLACZEGO TA TRASA? (Mosty/Tunele/Drogi)</strong></h5>';
            html += '<div style="font-family:monospace;font-size:0.85em;line-height:1.8;margin-top:15px;">';

            validation.routeJustification.forEach(line => {
                let style = 'margin:3px 0;';
                let content = escapeHtml(line);

                if (line.includes('‚ïê‚ïê‚ïê')) {
                    style += 'font-weight:bold;color:#0d6efd;font-size:1.15em;border-bottom:2px solid #0d6efd;padding:8px 0;margin-top:15px;';
                }
                else if (line.includes('MO≈ªNA PRZEJECHAƒÜ') || line.includes('ud≈∫wignie') || line.includes('ZATWIERDZONA') || line.includes('‚úî')) {
                    style += 'color:#28a745;font-weight:bold;background:#d4edda;padding:8px;border-radius:5px;margin:5px 0;';
                }
                else if (line.includes('OMIJAMY') || line.includes('ZA CIƒò≈ªKI') || line.includes('ZA WYSOKI') || line.includes('NARUSZENIE') || line.includes('‚úó')) {
                    style += 'color:#dc3545;font-weight:bold;background:#f8d7da;padding:8px;border-radius:5px;margin:5px 0;';
                }
                else if (line.includes('‚ö†') || line.includes('UWAGA') || line.includes('OGRANICZENIE')) {
                    style += 'color:#856404;font-weight:bold;background:#fff3cd;padding:8px;border-radius:5px;margin:5px 0;';
                }
                else if (line.includes('Most:') || line.includes('Tunel:') || line.includes('Droga:')) {
                    style += 'font-weight:bold;margin-top:10px;color:#495057;';
                }
                else if (line.startsWith('   ')) {
                    style += 'margin-left:25px;font-size:0.95em;color:#6c757d;';
                }

                html += `<div style="${style}">${content}</div>`;
            });

            html += '</div></div>';
        } else {
            html += '<div style="background:#fff3cd;border-left:4px solid #ffc107;padding:15px;margin-top:20px;border-radius:5px;">';
            html += '<h6 style="color:#856404;"><strong>Brak szczeg√≥≈Çowego uzasadnienia trasy</strong></h6>';
            html += '<p>System HERE Maps nie zwr√≥ci≈Ç szczeg√≥≈Çowych danych o infrastrukturze dla tej trasy.</p>';
            html += '</div>';
        }

        if (validation.violations && validation.violations.length > 0) {
            html += '<div style="background:#f8d7da;border-left:4px solid #dc3545;padding:15px;margin-top:20px;border-radius:5px;">';
            html += '<h6 style="color:#721c24;"><strong>Naruszenia (u≈ºyto trasy alternatywnej):</strong></h6><ul>';
            validation.violations.forEach(v => html += `<li>${escapeHtml(v)}</li>`);
            html += '</ul></div>';
        }

        if (validation.restrictions && validation.restrictions.length > 0) {
            html += '<div style="background:#fff3cd;border-left:4px solid #ffc107;padding:15px;margin-top:20px;border-radius:5px;">';
            html += '<h6 style="color:#856404;"><strong>Ograniczenia sprawdzone na trasie:</strong></h6><ul>';
            validation.restrictions.forEach(r => html += `<li>${escapeHtml(r)}</li>`);
            html += '</ul></div>';
        }

        if (!validation.hasViolations && !validation.hasRestrictions) {
            html += '<div style="background:#d4edda;border-left:4px solid #28a745;padding:15px;margin-top:20px;border-radius:5px;">';
            html += '<h6 style="color:#155724;"><strong>‚úÖ Trasa wolna od ogranicze≈Ñ!</strong></h6>';
            html += '<p>Wszystkie mosty, tunele i drogi zosta≈Çy sprawdzone i sƒÖ przejezdne dla tego zestawu.</p>';
            html += '</div>';
        }

        html += '</div>';

        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
        modal.innerHTML = `
            <div style="background:white;padding:0;border-radius:12px;max-width:1100px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);">
                ${html}
                <div style="padding:20px;border-top:2px solid #dee2e6;text-align:center;background:#f8f9fa;">
                    <button class="btn btn-secondary btn-lg" onclick="this.closest('div').parentElement.parentElement.remove()">Zamknij</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function showRouteOnMap(routeId) {
        try {
            const response = await fetch(`/api/routes/${routeId}/navigation-data`);
            const data = await response.json();

            const modal = document.getElementById('route-map-modal');
            document.getElementById('route-map-title').textContent = `Trasa #${routeId} - ${data.startAddress} ‚Üí ${data.endAddress}`;

            modal.style.display = 'flex';

            if (!routePreviewMap) {
                routePreviewMap = new google.maps.Map(document.getElementById('route-preview-map'), {
                    zoom: 10,
                    center: { lat: data.startLat, lng: data.startLng }
                });
            }

            routePreviewMap = new google.maps.Map(document.getElementById('route-preview-map'), {
                zoom: 10,
                center: { lat: data.startLat, lng: data.startLng }
            });

            new google.maps.Marker({
                position: { lat: data.startLat, lng: data.startLng },
                map: routePreviewMap,
                title: 'Start',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#34a853',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 3
                }
            });

            new google.maps.Marker({
                position: { lat: data.endLat, lng: data.endLng },
                map: routePreviewMap,
                title: 'Koniec',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#ea4335',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 3
                }
            });

            let coordinates = [];
            let routeColor = '#4285F4';
            let routeLabel = 'Google Maps';

            if (data.herePolyline) {
                coordinates = decodeHereFlexiblePolyline(data.herePolyline);
                routeColor = '#34a853';
                routeLabel = 'HERE Maps (Zwalidowana)';
            } else if (data.googleMapsRoutes && data.googleMapsRoutes.length > 0) {
                const route = data.googleMapsRoutes[0];
                if (route.overview_polyline?.points) {
                    coordinates = decodeGooglePolyline(route.overview_polyline.points);
                }
            }

            if (coordinates.length > 0) {
                new google.maps.Polyline({
                    path: coordinates,
                    geodesic: true,
                    strokeColor: routeColor,
                    strokeOpacity: 1.0,
                    strokeWeight: 5,
                    map: routePreviewMap
                });

                const bounds = new google.maps.LatLngBounds();
                coordinates.forEach(coord => bounds.extend(coord));
                routePreviewMap.fitBounds(bounds);

                console.log(`‚úÖ Wy≈õwietlono trasƒô: ${routeLabel} (${coordinates.length} punkt√≥w)`);
            }

        } catch (error) {
            console.error('B≈ÇƒÖd wy≈õwietlania trasy:', error);
            alert('Nie uda≈Ço siƒô za≈Çadowaƒá trasy na mapie');
        }
    }

    function closeRouteMapModal() {
        document.getElementById('route-map-modal').style.display = 'none';
    }

    /**
     * ‚úÖ FUNKCJA ≈öLEDZENIA KIEROWCY NA ≈ªYWO
     */
    async function showDriverLocation(driverUsername) {
        console.log(`üó∫Ô∏è Otwieram mapƒô dla kierowcy: ${driverUsername}`);
        currentTrackedDriver = driverUsername;

        const modal = document.getElementById('driver-location-modal');
        document.getElementById('driver-location-title').textContent = `üìç Lokalizacja kierowcy: ${driverUsername}`;

        modal.style.display = 'flex';

        if (!driverLocationMap) {
            driverLocationMap = new google.maps.Map(document.getElementById('driver-location-map'), {
                zoom: 16,
                center: { lat: 52.2297, lng: 21.0122 },
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
                zoomControl: true
            });
        }

        await updateDriverLocation(driverUsername);

        if (driverLocationInterval) clearInterval(driverLocationInterval);
        driverLocationInterval = setInterval(() => {
            updateDriverLocation(driverUsername);
        }, 3000);
    }

    async function updateDriverLocation(driverUsername) {
        try {
            const response = await fetch(`/api/tracking/driver/${driverUsername}/status`);
            if (!response.ok) {
                throw new Error('Nie uda≈Ço siƒô pobraƒá lokalizacji');
            }

            const driverInfo = await response.json();

            if (!driverInfo.isOnline || !driverInfo.latitude || !driverInfo.longitude) {
                document.getElementById('driver-status-live').textContent = '‚ö™ Offline';
                document.getElementById('driver-status-live').style.color = '#6c757d';
                return;
            }

            const position = {
                lat: driverInfo.latitude,
                lng: driverInfo.longitude
            };

            document.getElementById('driver-speed').textContent =
                driverInfo.speedKmh ? `${Math.round(driverInfo.speedKmh)} km/h` : '0 km/h';

            if (driverInfo.lastUpdate) {
                const lastUpdate = new Date(driverInfo.lastUpdate);
                const now = new Date();
                const diffSeconds = Math.floor((now - lastUpdate) / 1000);

                if (diffSeconds < 10) {
                    document.getElementById('driver-last-update').textContent = 'teraz';
                } else if (diffSeconds < 60) {
                    document.getElementById('driver-last-update').textContent = `${diffSeconds}s temu`;
                } else {
                    document.getElementById('driver-last-update').textContent =
                        `${Math.floor(diffSeconds / 60)}m temu`;
                }
            }

            document.getElementById('driver-status-live').textContent = 'üü¢ Online';
            document.getElementById('driver-status-live').style.color = '#28a745';

            if (driverLocationMarker) {
                driverLocationMarker.setMap(null);
            }

            driverLocationMarker = new google.maps.Marker({
                position: position,
                map: driverLocationMap,
                title: `Kierowca: ${driverUsername}`,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#4285F4',
                    fillOpacity: 1,
                    strokeColor: 'white',
                    strokeWeight: 3
                },
                animation: google.maps.Animation.DROP
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 10px;">
                        <h6 style="margin: 0 0 10px 0;">${driverUsername}</h6>
                        <p style="margin: 5px 0;"><strong>Trasa:</strong> ${driverInfo.routeDescription || 'Brak'}</p>
                        <p style="margin: 5px 0;"><strong>Prƒôdko≈õƒá:</strong> ${Math.round(driverInfo.speedKmh || 0)} km/h</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: #28a745;">üü¢ Online</span></p>
                    </div>
                `
            });

            driverLocationMarker.addListener('click', () => {
                infoWindow.open(driverLocationMap, driverLocationMarker);
            });

            driverLocationMap.panTo(position);

            console.log(`‚úÖ Zaktualizowano pozycjƒô kierowcy ${driverUsername}:`, position);

        } catch (error) {
            console.error('B≈ÇƒÖd aktualizacji lokalizacji kierowcy:', error);
            document.getElementById('driver-status-live').textContent = '‚ùå B≈ÇƒÖd';
            document.getElementById('driver-status-live').style.color = '#dc3545';
        }
    }

    function closeDriverLocationModal() {
        document.getElementById('driver-location-modal').style.display = 'none';

        if (driverLocationInterval) {
            clearInterval(driverLocationInterval);
            driverLocationInterval = null;
        }

        currentTrackedDriver = null;

        if (driverLocationMarker) {
            driverLocationMarker.setMap(null);
            driverLocationMarker = null;
        }
    }

    function decodeHereFlexiblePolyline(encoded) {
        const ENCODING_TABLE = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";

        let index = 0;
        let lat = 0;
        let lng = 0;
        const coordinates = [];

        const precisionChar = encoded.charAt(0);
        const precision = Math.pow(10, ENCODING_TABLE.indexOf(precisionChar));
        index++;

        while (index < encoded.length) {
            let shift = 0;
            let result = 0;
            let byte;

            do {
                byte = ENCODING_TABLE.indexOf(encoded.charAt(index++));
                if (byte === -1) throw new Error('Invalid character in polyline');
                result |= (byte & 0x1F) << shift;
                shift += 5;
            } while (byte >= 0x20);

            const latChange = (result & 1) ? ~(result >> 1) : (result >> 1);
            lat += latChange;

            shift = 0;
            result = 0;

            do {
                byte = ENCODING_TABLE.indexOf(encoded.charAt(index++));
                if (byte === -1) throw new Error('Invalid character in polyline');
                result |= (byte & 0x1F) << shift;
                shift += 5;
            } while (byte >= 0x20);

            const lngChange = (result & 1) ? ~(result >> 1) : (result >> 1);
            lng += lngChange;

            coordinates.push({
                lat: lat / precision,
                lng: lng / precision
            });
        }

        return coordinates;
    }

    function decodeGooglePolyline(encoded) {
        const coordinates = [];
        let index = 0;
        let lat = 0;
        let lng = 0;

        while (index < encoded.length) {
            let b, shift = 0, result = 0;

            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);

            const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += dlat;

            shift = 0;
            result = 0;

            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);

            const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += dlng;

            coordinates.push({ lat: lat / 1e5, lng: lng / 1e5 });
        }

        return coordinates;
    }

    function switchTab(tab) {
        document.querySelectorAll('#routes-section, #drivers-section, #vehicles-section, #add-equipment-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.btn-primary, .btn-outline-primary').forEach(el => {
            el.classList.remove('btn-primary');
            el.classList.add('btn-outline-primary');
        });

        if (tab === 'routes') {
            document.getElementById('routes-section').style.display = 'block';
            document.getElementById('routes-tab').classList.add('btn-primary');
            document.getElementById('routes-tab').classList.remove('btn-outline-primary');
            if (operatorDashboard?.loadAllRoutes) operatorDashboard.loadAllRoutes();
        } else if (tab === 'drivers') {
            document.getElementById('drivers-section').style.display = 'block';
            document.getElementById('drivers-tab').classList.add('btn-primary');
            document.getElementById('drivers-tab').classList.remove('btn-outline-primary');
            if (operatorDashboard?.loadDriversList) operatorDashboard.loadDriversList();
        } else if (tab === 'vehicles') {
            document.getElementById('vehicles-section').style.display = 'block';
            document.getElementById('vehicles-tab').classList.add('btn-primary');
            document.getElementById('vehicles-tab').classList.remove('btn-outline-primary');
            loadVehiclesTab();
        } else if (tab === 'add-equipment') {
            document.getElementById('add-equipment-section').style.display = 'block';
            document.getElementById('add-equipment-tab').classList.add('btn-primary');
            document.getElementById('add-equipment-tab').classList.remove('btn-outline-primary');
            loadEquipmentLists();
        }
    }

    async function loadVehiclesTab() {
        try {
            const [transporters, cargo, sets] = await Promise.all([
                fetch('/api/vehicles/transporters').then(r => r.json()),
                fetch('/api/vehicles/cargo').then(r => r.json()),
                fetch('/api/vehicles/transport-sets').then(r => r.json())
            ]);

            allCargo = cargo;

            document.getElementById('transporter-select').innerHTML = '<option value="">Wybierz...</option>' +
                transporters.map(t => `<option value="${t.id}">${t.model} (${t.totalWeightKg}kg)</option>`).join('');

            document.getElementById('cargo-select').innerHTML = '<option value="">Wybierz...</option>' +
                cargo.map(c => `<option value="${c.id}">${c.model} (${c.totalWeightKg}kg, ${c.heightCm}cm)${c.canDriveAlone ? ' üöó' : ''}</option>`).join('');

            document.getElementById('existing-sets').innerHTML = sets.map(set => `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6>${set.description || 'Zestaw #' + set.id}</h6>
                        <small>Ciƒô≈ºar√≥wka: ${set.transporter.model}</small><br>
                        <small>≈Åadunek: ${set.cargo.model}</small><br>
                        <small>Typ: ${set.trailerType || 'N/A'}</small><br>
                        <small>Waga: ${set.totalWeightKg}kg</small><br>
                        <small>Wysoko≈õƒá: ${set.totalHeightCm}cm</small>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            console.error('Error loading vehicles:', error);
        }
    }

    document.getElementById('vehicle-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const response = await fetch('/api/vehicles/transport-sets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    transporterId: document.getElementById('transporter-select').value,
                    cargoId: document.getElementById('cargo-select').value,
                    description: document.getElementById('set-description').value,
                    transportMode: selectedTransportMode
                })
            });

            if (response.ok) {
                alert('Zestaw utworzony!');
                document.getElementById('vehicle-form').reset();
                document.getElementById('transport-mode-container').style.display = 'none';
                selectedTransportMode = 'trailer';
                loadVehiclesTab();
                if (operatorDashboard?.loadTransportSets) operatorDashboard.loadTransportSets();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('B≈ÇƒÖd podczas tworzenia zestawu');
        }
    });

    document.getElementById('add-transporter-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const response = await fetch('/api/vehicles/transporters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: document.getElementById('trans-model').value,
                    totalWeightKg: parseInt(document.getElementById('trans-weight').value),
                    heightCm: parseInt(document.getElementById('trans-height').value),
                    maxAxleLoadKg: parseInt(document.getElementById('trans-axle').value)
                })
            });

            if (response.ok) {
                alert('Ciƒô≈ºar√≥wka dodana!');
                document.getElementById('add-transporter-form').reset();
                loadEquipmentLists();
                if (operatorDashboard?.loadTransportSets) operatorDashboard.loadTransportSets();
            } else {
                throw new Error('Failed');
            }
        } catch (error) {
            alert('B≈ÇƒÖd podczas dodawania ciƒô≈ºar√≥wki');
        }
    });

    document.getElementById('add-cargo-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const response = await fetch('/api/vehicles/cargo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: document.getElementById('cargo-model').value,
                    totalWeightKg: parseInt(document.getElementById('cargo-weight').value),
                    heightCm: parseInt(document.getElementById('cargo-height').value),
                    maxAxleLoadKg: parseInt(document.getElementById('cargo-axle').value)
                })
            });

            if (response.ok) {
                alert('≈Åadunek dodany!');
                document.getElementById('add-cargo-form').reset();
                loadEquipmentLists();
                if (operatorDashboard?.loadTransportSets) operatorDashboard.loadTransportSets();
            } else {
                throw new Error('Failed');
            }
        } catch (error) {
            alert('B≈ÇƒÖd podczas dodawania ≈Çadunku');
        }
    });

    async function loadEquipmentLists() {
        try {
            const [transporters, cargo] = await Promise.all([
                fetch('/api/vehicles/transporters').then(r => r.json()),
                fetch('/api/vehicles/cargo').then(r => r.json())
            ]);

            document.getElementById('transporters-list').innerHTML = transporters.map(t => `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <strong>${t.model}</strong><br>
                        <small>Waga: ${t.totalWeightKg}kg, Wys: ${t.heightCm}cm</small>
                    </div>
                </div>
            `).join('');

            document.getElementById('cargo-list').innerHTML = cargo.map(c => `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <strong>${c.model}</strong> ${c.canDriveAlone ? 'üöó' : ''}<br>
                        <small>Waga: ${c.totalWeightKg}kg, Wys: ${c.heightCm}cm</small>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            console.error('Error loading equipment:', error);
        }
    }

    function assignDriver(routeId) {
        const username = prompt('Nazwa kierowcy:');
        if (!username) return;

        fetch(`/api/routes/${routeId}/assign-driver?driverUsername=${username}`, {
            method: 'POST'
        }).then(r => {
            if (r.ok) {
                alert('Kierowca przypisany');
                if (operatorDashboard?.loadAllRoutes) operatorDashboard.loadAllRoutes();
            }
        });
    }

    function deleteRoute(routeId) {
        if (!confirm('UsunƒÖƒá trasƒô #' + routeId + '?')) return;

        fetch(`/api/routes/${routeId}`, {
            method: 'DELETE'
        }).then(r => {
            if (r.ok) {
                alert('Trasa usuniƒôta');
                if (operatorDashboard?.loadAllRoutes) operatorDashboard.loadAllRoutes();
            }
        });
    }

    function refreshRoutes() {
        if (operatorDashboard?.loadAllRoutes) operatorDashboard.loadAllRoutes();
    }

    function refreshDrivers() {
        if (operatorDashboard?.loadDriversList) operatorDashboard.loadDriversList();
    }

    function showAddDriverModal() {
        if (operatorDashboard?.showAddDriverModal) operatorDashboard.showAddDriverModal();
    }

    function logout() {
        if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?')) {
            if (operatorDashboard?.destroy) operatorDashboard.destroy();

            if (driverLocationInterval) {
                clearInterval(driverLocationInterval);
                driverLocationInterval = null;
            }

            localStorage.clear();
            window.location.href = '/login.html';
        }
    }

    window.addEventListener('beforeunload', () => {
        if (driverLocationInterval) {
            clearInterval(driverLocationInterval);
        }
    });

    document.addEventListener('DOMContentLoaded', initializeSystem);
</script>
</body>
</html>